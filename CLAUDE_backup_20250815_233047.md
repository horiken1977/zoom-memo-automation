# Zoom Memo Automation プロジェクトガイドライン & 対話記録

このドキュメントは、Claude Codeがこのプロジェクトで作業する際に守るべきルールとガイドライン、および対話記録を定義しています。

## 🚨 【強制実行】作業開始プロトコル - 絶対に忘れるな！

**Claude Codeは以下を作業開始時に必ず実行すること（例外なし）**

### ステップ0: セッション自動保存（VSCodeクラッシュ対策）
```bash
# VSCodeクラッシュ対策として、必ず最初にセッション保存を実行
./3.operations/src/save_claude_session.sh

# セッション保存が失敗した場合のみスクリプト作成
if [ ! -f "./3.operations/src/save_claude_session.sh" ]; then
    echo "セッション保存スクリプトが存在しないため作成が必要"
fi
```

### ステップ1: Cipher復元確認（クラッシュ復旧時）
```
VSCodeクラッシュ後の場合：
1. MCPのCipherを用いて前回の対話記録を復元
2. 3.operations/claude_sessions/latest_session.md を確認
3. 必要に応じて 0.docs/crash_recovery_guide.md 参照
```

### ステップ2: 現状確認（必須）
```bash
# 1. 現在のgitステータス確認
git status
git log --oneline -5

# 2. 前回からの変更差分確認
git diff HEAD~1 --name-only
```

### ステップ3: TodoWrite強制リマインダー（必須）
```
毎回最初に以下タスクを作成：
1. "【必須】セッション自動保存実行" (in_progress)
2. "【必須】現状確認プロトコル実行" (pending)
3. "git status/log確認完了" (pending) 
4. "前回変更差分確認完了" (pending)
5. "動作確認テスト実行完了" (pending)
6. "【デグレ防止】影響範囲調査完了" (pending)
7. "【デグレ防止】バックアップポイント作成完了" (pending)
8. "【デグレ防止】修正戦略計画完了" (pending)

この8つを全て completed にしてからコード修正作業開始
```

### ステップ4: コード修正前の影響範囲調査（デグレ防止強制プロトコル）
```
【絶対必須】コード修正前に以下を実行：

1. 影響範囲調査の実施
   grep -r "修正対象のキーワード" 1.src/ --include="*.js" | wc -l
   find . -name "*.js" -exec grep -l "関連データ構造" {} \;

2. 影響度判定と修正戦略決定
   - 狭い（1-2ファイル）: 単一修正戦略
   - 中程度（3-4ファイル）: 段階的修正戦略  
   - 広い（5ファイル+）: Phase分割戦略

3. バックアップポイント作成
   git tag backup-$(date +%Y%m%d-%H%M%S)

4. 修正範囲とテスト計画の明文化
   echo "修正範囲: [ファイルリスト]" > .modification_plan
   echo "テスト戦略: [Phase別テスト]" >> .modification_plan
```

### ステップ5: エラー発生時の強制プロトコル
```
エラー発生 → 必ず以下を確認：
1. 最近の変更と関係があるか？ (git diff確認)
2. 変更していない部分でのエラーか？
3. 論理的因果関係があるか？
4. 環境要因の可能性は？
5. 即座ロールバック可能か？ (git tag確認)
```

### ステップ6: 変更前の動作確認
- 修正対象の現在の動作状況を必ず確認
- テスト実行で正常性を検証
- 問題がある場合は修正前に報告

### ステップ7: 作業完了時のセッション保存
```bash
# 重要な作業完了時は必ずセッション保存
./3.operations/src/save_claude_session.sh
```

**このプロトコルを飛ばして作業を開始してはいけない！**

## 🎯 プロジェクト概要

Zoom録画ファイルを自動で文字起こし・要約し、Google Driveに保存してSlackに通知するシステムです。
- **本番環境**: Vercel (Hobbyプラン)
- **主要技術**: Node.js, Google APIs (Drive, Gemini AI), Slack API, Zoom API
- **開始日**: 2025年7月30日

## 📋 重要な作業ルール

### 0.0 Claude codeとの対話について
- Claude code は全てのチャットの冒頭にこのファイルの原則を逐語的に必ず画面出力してから対応する。
- **作業開始時に必ず上記の【強制実行】作業開始プロトコルを実行すること**
- **プロトコル未実行での作業開始は禁止**

### 0. 基本開発方針
#### 開発ドキュメントの作成と自動更新
- 開発ダッシュボード、機能設計書、環境設計書、テスト仕様書を作成
- html形式で全てをダッシュボードから確認できるようにする。
- ダッシュボードにはそれぞれの設計や仕様に関する進捗状況を記載。
- 進捗状況は全体のうちの今何％か、現在どのフェーズか、次にやるべきことはなにか、などがグラフィカルに誰の目で見てもわかるように表現。
- htmlはGithub上から閲覧可能にすること。
- Claude codeとのチャット履歴をもとに自動的に開発ドキュメントを更新する仕組みにする。
- ドキュメント更新の仕組みは、MCPサーバのcipherの機能を使い、自動的に機能や環境、テストなどの指示を読み取ってドキュメント類に自動的に更新する。
- IDEがクラッシュやPCの再起動が発生してもリカバリできるようにcipherの再読み込み方法などを上記ドキュメントに記載する。
- 上記のドキュメントおよび自動更新の仕組みなどは、リポジトリトップの配下にdocsフォルダを作成して保存してください。
- 加えて、テスト実施用のスクリプトやデータを保存するためのtestフォルダもリポジトリトップの配下に作成してください。
- test/scripts をスクリプト類、test/data をテストで利用するデータ類の保存先にしてください（この構成も当然、環境設計書に自動記録の仕組みを使って記載してください）
- フォルダ構造    
    ```
    フォルダ構造
     
    プロジェクトルート/
    ├── 0.docs/                 # ドキュメント用フォルダ
    │   ├── index.html          # 開発ダッシュボード（主に全ドキュメントのまとめと進捗状況表示）
    │   ・・・                   # 開発ダッシュボード以外のドキュメント（機能・非機能設計書、環境設計書、テスト仕様書）
    └── 1.src/                   # プログラムソース用フォルダ
    │   ├─・・・
    │
    ├── 2.tests/
    │   ├── data/                # テストデータ
    │   └── tools/               # テストツール類
    │   
    └── 3.operations/            # 運用関連の仕組み
        ├── src/                 # Claude codeとの対話記録自動保存スクリプト
     
    ```

### プログラムソースの扱い
- プログラムはGitHub上にプッシュしてください。
- また、本番環境はVercelに実装するようにしてください。

### 禁止事項
- AI側で独自のルール作成
- 指示した以外の無関係のフォルダやファイルの削除
- APIキーやIPアドレスなどのセキュリティ情報および可変データをコード内にベタ書きすること（セキュリティ情報はプラットフォームの環境変数を利用。変数などの可変データは外から入力するか別ファイル二保存して呼び出す形にすること）

### デグレ防止の禁止事項（絶対厳守）
- 影響範囲調査なしでのコード修正
- バックアップポイントなしでの大規模修正
- 複数ファイル同時修正（影響範囲調査で戦略決定後は除く）
- 動作中の機能の削除・置換（並行実装→段階移行の原則）
- Phase分割なしでの5ファイル以上修正
- テスト前の本番デプロイ（段階的修正戦略の場合）
- ロールバック手順未確立での修正開始

### 1. テスト環境と実装方針

#### ✅ やるべきこと
- **本番環境でのテスト実施**: Vercelの本番環境を使用してテストを行う
- **既存コードの活用**: 本番環境で稼働している実際のコードを使用してテストする
- **既存ファイルの編集優先**: 新規ファイル作成よりも既存ファイルの編集を優先する

#### ❌ やってはいけないこと
- **新しいテストスクリプトの作成を避ける**: 既存のコードにデバッグ処理を組み込む
- **ローカル環境でのテスト**: 環境依存の問題を避けるため、必ずVercel環境で実行
- **別コードでの個別テスト**: メソッド名やAPIの書き間違いを防ぐため、本番コードを使用

### 2. デバッグとトラブルシューティング

#### デバッグ時の原則
- 本番コードに直接デバッグログを追加する
- 時間測定や詳細ログは本番コード内に実装する
- エラー発生時は詳細な実行時間とステップ情報を記録する

### 3. Vercel環境の制約

#### 認識すべき制限
- **Hobbyプラン制限**: 
  - 設定上は`maxDuration: 300`（5分）
  - 実際の動作は調査中（60秒制限の可能性あり）
- **サーバーレス環境**:
  - ファイルシステムへの書き込み不可
  - メモリバッファ処理を使用
  - 一時ファイル作成を避ける

### 4. API使用上の注意

#### Google Drive API
- 共有ドライブ対応: `supportsAllDrives: true`を必須で設定
- 組織ドメイン: `grtx.jp`

#### Gemini AI API
- モデル: `gemini-2.5-pro`（自動選択）
- 大容量音声ファイル処理時のタイムアウトに注意

## 🔧 技術仕様

### ディレクトリ構造
```
/api/                     # Vercel APIエンドポイント
  monitor-recordings-gdrive-test.js  # TC203/204/205テスト
/1.src/services/         # サービスレイヤー
  audioSummaryService.js # 音声処理・要約
  videoStorageService.js # 動画保存
  googleDriveService.js  # Google Drive操作
  slackService.js        # Slack通知
  aiService.js          # Gemini AI処理
/0.docs/                # ドキュメント
  test-specification.html # テスト仕様書
```

### テストケース
- **TC203**: 8項目構造化要約テスト（メモリバッファ処理）
- **TC204**: VideoStorageService動画処理テスト
- **TC205**: End-to-End統合テスト

## 🚀 デプロイとテスト手順

### 1. コード変更後のデプロイ
```bash
git add .
git commit -m "feat/fix: 変更内容の説明"
git push origin main
```

### 2. Vercel環境でのテスト実行
```bash
# デプロイ完了待機（約15-30秒）
sleep 15

# テスト実行
curl "https://zoom-memo-automation.vercel.app/api/monitor-recordings-gdrive-test?test=TC203"
```

### 3. ログ確認
```bash
# Vercelログ確認
vercel logs https://zoom-memo-automation.vercel.app
```

## 💡 トラブルシューティング

### よくある問題と対処法

#### 1. タイムアウトエラー
- **原因**: Vercel Hobbyプランの制限
- **対処**: 
  - 処理を分割して実行
  - より小さなテストデータを使用
  - 非同期処理の最適化

#### 2. Google Drive API エラー
- **原因**: 共有ドライブへのアクセス権限
- **対処**: `supportsAllDrives: true`フラグの確認

#### 3. Gemini API レスポンス遅延
- **原因**: 大容量ファイルの処理
- **対処**: 
  - ファイルサイズを制限
  - バッファサイズの最適化

## 📝 コミットメッセージ規約

```
feat: 新機能追加
fix: バグ修正  
refactor: リファクタリング
test: テストコード追加・修正
docs: ドキュメント更新
perf: パフォーマンス改善
debug: デバッグコード追加
```

## 🔐 環境変数

以下の環境変数がVercelに設定されています（変更不要）：
- `GOOGLE_DRIVE_RECORDINGS_FOLDER`: 録画保存フォルダID
- `GOOGLE_DRIVE_ORG_DOMAIN`: grtx.jp
- `SLACK_BOT_TOKEN`: Slackボットトークン
- `SLACK_CHANNEL_ID`: 通知先チャンネルID
- `GOOGLE_AI_API_KEY`: Gemini APIキー
- Google Drive認証情報（各種）

## ⚠️ 重要な注意事項

1. **本番環境での作業**: すべてのテストは本番環境（Vercel）で実施すること
2. **既存コードの尊重**: 新規ファイル作成よりも既存ファイルの修正を優先
3. **メモリ処理優先**: ファイルI/Oを避け、メモリバッファで処理
4. **エラーハンドリング**: 詳細なエラー情報とタイミング情報を記録
5. **段階的デバッグ**: 問題を小さく分割して段階的に調査

## 📞 コミュニケーション

- 作業前に現状を確認し、ユーザーの要望を正確に理解する
- 新しいアプローチを試す前に、ユーザーに確認を取る
- エラーや制限事項は明確に説明する

## 📝 最新の対話記録と問題解決状況

### 2025-08-15 対話記録

#### 実施内容
- SlackとDrive保存要約の内容不一致問題の解決
- 7項目構造対応の完全実装
- API一時的エラーのエラーコード体系整備
- アーキテクチャ分析と段階的改善計画

#### 主要な成果
- **SlackとDrive要約の完全一致** ✅
  - discussionFlow.keyArguments構造への対応
  - 発言者の論理展開詳細表示
- **エラーコード体系の改善** ✅
  - API一時的エラーの分類と統一メッセージ
  - AU003/004/005/007/008, ZM001/003/004, GD001/003/004, SL001/006/007

#### API処理の一時的失敗について
- **現象**: 同じ音声データで一時的に文字起こしが50文字未満
- **原因**: API側の一時的な不安定性
- **対処**: 時間を置いて再実行で解決

### 2025-08-08 対話記録

#### 実施内容
- TC205テスト成功確認（228.8秒）
- PT001本番スルーテスト実装
- Zoom OAuth/JWT認証問題の診断
- JWT認証フォールバックテスト実装
- **Zoom認証問題の完全解決** ✅

#### Zoom認証問題の解決状況
- **OAuth認証: 成功** ✅
  - 環境変数マッピング修正（ZOOM_API_KEY/SECRET）
  - APIエンドポイント修正（/users/me/recordings）
  - Server-to-Server OAuth正常動作確認
- **録画リスト取得: 成功** ✅
  - 7件の録画データ取得確認
  - API接続完全正常化

#### PT001本番スルーテスト結果
- Zoom API接続: ✅ 成功（202ms）
- 録画データ取得: ✅ 成功（101ms）
- 音声要約処理: ❌ タイムアウト（97秒）
- **Zoom録画削除: 実行せず**（安全設計）

#### 成果
- **Zoom連携の本番運用準備完了**
- OAuth認証の完全動作確認
- 録画自動処理システムの基盤確立

#### Cipher自動保存
- 保存時刻: 2025-08-08T07:43:00.000Z
- セッションID: 1754638980000

### 2025/07/31 16:42 - Claude対話自動記録システムの実装

**ユーザー要求:**
本チャット情報を自動で分析・保存して設計書に反映する仕組みを構築しましたがそれは稼働していますか？稼働していないように見えるのですが

**実装内容:**
自動更新機能が未実装であることを確認し、以下のシステムを新規実装しました：

**変更点:**
- ClaudeDocUpdater クラスを実装（対話記録の自動保存・分析）
- claude-webhook API エンドポイントを追加（外部からの対話受信）
- claude-monitor スクリプトを作成（ファイル監視による自動更新）
- 設計書HTMLに自動更新JavaScriptを埋め込み
- claude-status API を追加（更新状態の確認）
- package.json に必要な依存関係（chokidar, xml2js）を追加

**技術詳細:**
- ファイル監視: chokidar によるリアルタイム変更検知
- API通信: /api/claude-webhook で対話記録を受信
- 自動更新: 5分間隔で設計書の更新をチェック
- 変更検出: 正規表現による実装内容の自動抽出

### 2025/07/30 - 開発環境整備

**ユーザーからの要求:**
- 開発環境の整備
- ドキュメントの作成と自動更新システム
- フォルダ構造の構築
- Claude Code対話記録の自動保存
- GitHub & Vercel環境の設定

**実装内容:**

#### 1. フォルダ構造の作成
```
zoom-memo-automation/
├── 0.docs/                 # ドキュメント類
│   ├── index.html          # 開発ダッシュボード
│   ├── functional-design.html
│   ├── environment-design.html
│   ├── test-specification.html
│   └── claude.md           # 対話記録
├── 1.src/                  # プログラムソース
├── 2.tests/                # テスト関連
│   ├── data/               # テストデータ
│   └── tools/              # テストツール
└── 3.operations/           # 運用関連
    ├── src/                # 運用スクリプト
    ├── configs/            # 設定ファイル
    └── logs/               # ログファイル
```

#### 2. 開発ダッシュボード
- プロジェクト進捗の可視化
- グラフィカルな進捗表示（Chart.js使用）
- 各ドキュメントへのナビゲーション
- リアルタイム更新機能

#### 3. 設計ドキュメント
- **機能設計書:** システム機能の詳細仕様
  - Zoom連携機能（F001）
  - 音声認識機能（F002）
  - 議事録生成機能（F003）
  - 配信機能（F004）
  
- **環境設計書:** 開発・本番環境の設計
  - フォルダ構造
  - 技術スタック（Next.js, Node.js, TypeScript）
  - Vercel デプロイメント設定
  - 外部サービス連携（Zoom, OpenAI, AWS）
  
- **テスト仕様書:** テスト計画・仕様
  - ユニットテスト、統合テスト、E2Eテスト
  - テストケース定義
  - 自動化ツール設定

#### 4. 自動化システム
- **chat-backup.js:** Claude対話記録自動保存
  - 2時間毎の自動バックアップ
  - 対話内容からの機能・環境・テスト要件抽出
  - ドキュメント自動更新
  - バックアップファイル管理

- **monitor.js:** システム監視
  - バックアップ状況の定期確認
  - ターミナルへの状況表示
  - 問題検知とアラート

#### 5. Vercel設定
- 静的サイトホスティング設定
- ドキュメントルーティング
- 本番環境デプロイ準備

---

## 技術スタック

### フロントエンド
- **フレームワーク:** Next.js 14.x
- **言語:** TypeScript 5.x
- **ライブラリ:** React 18.x, Chart.js

### バックエンド
- **ランタイム:** Node.js 18.x
- **フレームワーク:** Express
- **API:** OpenAI Whisper, Zoom Webhook, Gemini AI

### インフラ
- **ホスティング:** Vercel
- **ストレージ:** Google Drive
- **データベース:** PostgreSQL (予定)

### 開発ツール
- **AI支援:** Claude Code
- **バージョン管理:** Git
- **CI/CD:** GitHub Actions (予定)

---

## 進捗状況

### 完了済み ✅
- [x] プロジェクト構造設計
- [x] フォルダ構造作成
- [x] 開発ダッシュボード作成
- [x] 機能設計書テンプレート
- [x] 環境設計書テンプレート
- [x] テスト仕様書テンプレート
- [x] 対話記録自動保存システム
- [x] 監視スクリプト
- [x] Vercel設定
- [x] Zoom認証問題解決
- [x] 7項目構造化要約実装
- [x] SlackとDrive要約の統一

### 進行中 🚧
- [ ] 異常系テスト実装
- [ ] API一時的エラーのSlack通知機能

### 未開始 ⏳
- [ ] 管理者向けダッシュボード
- [ ] エラー分析レポート機能
- [ ] 自動リカバリー機能

---

## 実行コマンド

### 自動保存システムの開始
```bash
# 対話記録の自動保存開始
node 3.operations/src/chat-backup.js

# カスタム設定での実行
node 3.operations/src/chat-backup.js --interval=3600 --output=custom-path.md
```

### 監視システムの実行
```bash
# 連続監視の開始
node 3.operations/src/monitor.js

# 一回だけのチェック
node 3.operations/src/monitor.js --once

# 静寂モード（最小限の出力）
node 3.operations/src/monitor.js --quiet
```

---

最終更新: 2025-08-15T11:00:00.000Z
自動保存: Claude Code対話記録