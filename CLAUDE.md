# Zoom Memo Automation プロジェクトガイドライン

このドキュメントは、Claude Codeがこのプロジェクトで作業する際に守るべきルールとガイドラインを定義しています。

## 🚨 【強制実行】作業開始プロトコル - 絶対に忘れるな！

**Claude Codeは以下を作業開始時に必ず実行すること（例外なし）**

### ステップ0: セッション自動保存（VSCodeクラッシュ対策）
```bash
# VSCodeクラッシュ対策として、必ず最初にセッション保存を実行
./3.operations/src/save_claude_session.sh

# セッション保存が失敗した場合のみスクリプト作成
if [ ! -f "./3.operations/src/save_claude_session.sh" ]; then
    echo "セッション保存スクリプトが存在しないため作成が必要"
fi
```

### ステップ1: Cipher復元確認（クラッシュ復旧時）
```
VSCodeクラッシュ後の場合：
1. MCPのCipherを用いて前回の対話記録を復元
2. 3.operations/claude_sessions/latest_session.md を確認
3. 必要に応じて 0.docs/crash_recovery_guide.md 参照
```

### ステップ2: 現状確認（必須）
```bash
# 1. 現在のgitステータス確認
git status
git log --oneline -5

# 2. 前回からの変更差分確認
git diff HEAD~1 --name-only
```

### ステップ3: TodoWrite強制リマインダー（必須）
```
毎回最初に以下タスクを作成：
1. "【必須】セッション自動保存実行" (in_progress)
2. "【必須】現状確認プロトコル実行" (pending)
3. "git status/log確認完了" (pending) 
4. "前回変更差分確認完了" (pending)
5. "動作確認テスト実行完了" (pending)

この5つを全て completed にしてから他の作業開始
```

### ステップ4: エラー発生時の強制プロトコル
```
エラー発生 → 必ず以下を確認：
1. 最近の変更と関係があるか？ (git diff確認)
2. 変更していない部分でのエラーか？
3. 論理的因果関係があるか？
4. 環境要因の可能性は？
```

### ステップ5: 変更前の動作確認
- 修正対象の現在の動作状況を必ず確認
- テスト実行で正常性を検証
- 問題がある場合は修正前に報告

### ステップ6: 作業完了時のセッション保存
```bash
# 重要な作業完了時は必ずセッション保存
./3.operations/src/save_claude_session.sh
```

**このプロトコルを飛ばして作業を開始してはいけない！**

## 🎯 プロジェクト概要

Zoom録画ファイルを自動で文字起こし・要約し、Google Driveに保存してSlackに通知するシステムです。
- **本番環境**: Vercel (Hobbyプラン)
- **主要技術**: Node.js, Google APIs (Drive, Gemini AI), Slack API, Zoom API

## 📋 重要な作業ルール
### 0.0 Claude codeとの対話について
- Claude code は全てのチャットの冒頭にこのファイルの原則を逐語的に必ず画面出力してから対応する。
- **作業開始時に必ず上記の【強制実行】作業開始プロトコルを実行すること**
- **プロトコル未実行での作業開始は禁止**
### 0. 基本開発方針
#### 開発ドキュメントの作成と自動更新
- 開発ダッシュボード、機能設計書、環境設計書、テスト仕様書を作成
- html形式で全てをダッシュボードから確認できるようにする。
- ダッシュボードにはそれぞれの設計や仕様に関する進捗状況を記載。
- 進捗状況は全体のうちの今何％か、現在どのフェーズか、次にやるべきことはなにか、などがグラフィカルに誰の目で見てもわかるように表現。
- htmlはGithub上から閲覧可能にすること。
- Claude codeとのチャット履歴をもとに自動的に開発ドキュメントを更新する仕組みにする。
- ドキュメント更新の仕組みは、MCPサーバのcipherの機能を使い、自動的に機能や環境、テストなどの指示を読み取ってドキュメント類に自動的に更新する。
- IDEがクラッシュやPCの再起動が発生してもリカバリできるようにcipherの再読み込み方法などを上記ドキュメントに記載する。
- 上記のドキュメントおよび自動更新の仕組みなどは、リポジトリトップの配下にdocsフォルダを作成して保存してください。
- 加えて、テスト実施用のスクリプトやデータを保存するためのtestフォルダもリポジトリトップの配下に作成してください。
- test/scripts をスクリプト類、test/data をテストで利用するデータ類の保存先にしてください（この構成も当然、環境設計書に自動記録の仕組みを使って記載してください）
- フォルダ構造    
    ```
    フォルダ構造
     
    プロジェクトルート/
    ├── 0.docs/                 # ドキュメント用フォルダ
    │   ├── claude.md           # 対話記録
    │   ├── index.html          # 開発ダッシュボード（主に全ドキュメントのまとめと進捗状況表示）
    │   ・・・                   # 開発ダッシュボード以外のドキュメント（機能・非機能設計書、環境設計書、テスト仕様書）
    └── 1.src/                   # プログラムソース用フォルダ
    │   ├─・・・
    │
    ├── 2.tests/
    │   ├── data/                # テストデータ
    │   └── tools/               # テストツール類
    │   
    └── 3.operations/            # 運用関連の仕組み
        ├── src/                 # Claude codeとの対話記録自動保存スクリプト
     
    ```
### プログラムソースの扱い
- プログラムはGitHub上にプッシュしてください。
- また、本番環境はVercelに実装するようにしてください。

### 禁止事項
- AI側で独自のルール作成
- 指示した以外の無関係のフォルダやファイルの削除
- APIキーやIPアドレスなどのセキュリティ情報および可変データをコード内にベタ書きすること（セキュリティ情報はプラットフォームの環境変数を利用。変数などの可変データは外から入力するか別ファイル二保存して呼び出す形にすること）

### 1. テスト環境と実装方針

#### ✅ やるべきこと
- **本番環境でのテスト実施**: Vercelの本番環境を使用してテストを行う
- **既存コードの活用**: 本番環境で稼働している実際のコードを使用してテストする
- **既存ファイルの編集優先**: 新規ファイル作成よりも既存ファイルの編集を優先する

#### ❌ やってはいけないこと
- **新しいテストスクリプトの作成を避ける**: 既存のコードにデバッグ処理を組み込む
- **ローカル環境でのテスト**: 環境依存の問題を避けるため、必ずVercel環境で実行
- **別コードでの個別テスト**: メソッド名やAPIの書き間違いを防ぐため、本番コードを使用

### 2. デバッグとトラブルシューティング

#### デバッグ時の原則
- 本番コードに直接デバッグログを追加する
- 時間測定や詳細ログは本番コード内に実装する
- エラー発生時は詳細な実行時間とステップ情報を記録する

### 3. Vercel環境の制約

#### 認識すべき制限
- **Hobbyプラン制限**: 
  - 設定上は`maxDuration: 300`（5分）
  - 実際の動作は調査中（60秒制限の可能性あり）
- **サーバーレス環境**:
  - ファイルシステムへの書き込み不可
  - メモリバッファ処理を使用
  - 一時ファイル作成を避ける

### 4. API使用上の注意

#### Google Drive API
- 共有ドライブ対応: `supportsAllDrives: true`を必須で設定
- 組織ドメイン: `grtx.jp`

#### Gemini AI API
- モデル: `gemini-2.5-pro`（自動選択）
- 大容量音声ファイル処理時のタイムアウトに注意

## 🔧 技術仕様

### ディレクトリ構造
```
/api/                     # Vercel APIエンドポイント
  monitor-recordings-gdrive-test.js  # TC203/204/205テスト
/1.src/services/         # サービスレイヤー
  audioSummaryService.js # 音声処理・要約
  videoStorageService.js # 動画保存
  googleDriveService.js  # Google Drive操作
  slackService.js        # Slack通知
  aiService.js          # Gemini AI処理
/0.docs/                # ドキュメント
  test-specification.html # テスト仕様書
```

### テストケース
- **TC203**: 8項目構造化要約テスト（メモリバッファ処理）
- **TC204**: VideoStorageService動画処理テスト
- **TC205**: End-to-End統合テスト

## 🚀 デプロイとテスト手順

### 1. コード変更後のデプロイ
```bash
git add .
git commit -m "feat/fix: 変更内容の説明"
git push origin main
```

### 2. Vercel環境でのテスト実行
```bash
# デプロイ完了待機（約15-30秒）
sleep 15

# テスト実行
curl "https://zoom-memo-automation.vercel.app/api/monitor-recordings-gdrive-test?test=TC203"
```

### 3. ログ確認
```bash
# Vercelログ確認
vercel logs https://zoom-memo-automation.vercel.app
```

## 💡 トラブルシューティング

### よくある問題と対処法

#### 1. タイムアウトエラー
- **原因**: Vercel Hobbyプランの制限
- **対処**: 
  - 処理を分割して実行
  - より小さなテストデータを使用
  - 非同期処理の最適化

#### 2. Google Drive API エラー
- **原因**: 共有ドライブへのアクセス権限
- **対処**: `supportsAllDrives: true`フラグの確認

#### 3. Gemini API レスポンス遅延
- **原因**: 大容量ファイルの処理
- **対処**: 
  - ファイルサイズを制限
  - バッファサイズの最適化

## 📝 コミットメッセージ規約

```
feat: 新機能追加
fix: バグ修正  
refactor: リファクタリング
test: テストコード追加・修正
docs: ドキュメント更新
perf: パフォーマンス改善
debug: デバッグコード追加
```

## 🔐 環境変数

以下の環境変数がVercelに設定されています（変更不要）：
- `GOOGLE_DRIVE_RECORDINGS_FOLDER`: 録画保存フォルダID
- `GOOGLE_DRIVE_ORG_DOMAIN`: grtx.jp
- `SLACK_BOT_TOKEN`: Slackボットトークン
- `SLACK_CHANNEL_ID`: 通知先チャンネルID
- `GOOGLE_AI_API_KEY`: Gemini APIキー
- Google Drive認証情報（各種）

## ⚠️ 重要な注意事項

1. **本番環境での作業**: すべてのテストは本番環境（Vercel）で実施すること
2. **既存コードの尊重**: 新規ファイル作成よりも既存ファイルの修正を優先
3. **メモリ処理優先**: ファイルI/Oを避け、メモリバッファで処理
4. **エラーハンドリング**: 詳細なエラー情報とタイミング情報を記録
5. **段階的デバッグ**: 問題を小さく分割して段階的に調査

## 📞 コミュニケーション

- 作業前に現状を確認し、ユーザーの要望を正確に理解する
- 新しいアプローチを試す前に、ユーザーに確認を取る
- エラーや制限事項は明確に説明する

## 📝 最新の対話記録と問題解決状況

### 2025-08-08 対話記録

#### 実施内容
- TC205テスト成功確認（228.8秒）
- PT001本番スルーテスト実装
- Zoom OAuth/JWT認証問題の診断
- JWT認証フォールバックテスト実装
- **Zoom認証問題の完全解決** ✅

#### Zoom認証問題の解決状況
- **OAuth認証: 成功** ✅
  - 環境変数マッピング修正（ZOOM_API_KEY/SECRET）
  - APIエンドポイント修正（/users/me/recordings）
  - Server-to-Server OAuth正常動作確認
- **録画リスト取得: 成功** ✅
  - 7件の録画データ取得確認
  - API接続完全正常化

#### PT001本番スルーテスト結果
- Zoom API接続: ✅ 成功（202ms）
- 録画データ取得: ✅ 成功（101ms）
- 音声要約処理: ❌ タイムアウト（97秒）
- **Zoom録画削除: 実行せず**（安全設計）

#### 成果
- **Zoom連携の本番運用準備完了**
- OAuth認証の完全動作確認
- 録画自動処理システムの基盤確立

#### Cipher自動保存
- 保存時刻: 2025-08-08T07:43:00.000Z
- セッションID: 1754638980000

---

最終更新: 2025-08-08T07:43:00.000Z
自動保存: Claude Code対話記録
