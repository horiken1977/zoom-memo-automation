# Zoom Memo Automation プロジェクトガイドライン

このドキュメントは、Claude Codeがこのプロジェクトで作業する際に守るべきルールとガイドラインを定義しています。

## 🔴 【最重要】要件理解確認プロトコル - 実装前必須！

**⚠️ 2025-09-23追加: 要件理解ミス防止の絶対ルール**

### 要件理解確認の強制プロトコル（自動実行必須）

#### 【自動実行】実装前チェック（必須実行）
```bash
# Claude Codeは実装開始前に必ずこのコマンドを実行すること
npm run verify-requirements-pre "ユーザー要求の逐語的引用" '{"method":"実装方法","steps":["手順1","手順2"],"targetFiles":["対象ファイル"]}'

# 例: 2段階フロー実装の場合
npm run verify-requirements-pre "完全文字起こし処理→文字起こし完了後に要約" '{"method":"真の2段階フロー","steps":["全チャンク文字起こし","完了後一括要約"],"targetFiles":["1.src/services/audioSummaryService.js"]}'
```

#### 【自動実行】実装後チェック（コミット前必須）
```bash
# Claude Codeは実装完了後、コミット前に必ずこのコマンドを実行すること
npm run verify-requirements-post '["修正ファイル1","修正ファイル2"]' '[{"description":"期待動作","file":"対象ファイル","shouldExist":["必須パターン"],"shouldNotExist":["削除パターン"]}]'

# 例: チャンク処理で要約生成停止の場合
npm run verify-requirements-post '["1.src/services/audioSummaryService.js"]' '[{"description":"チャンク内要約生成の削除","file":"1.src/services/audioSummaryService.js","shouldNotExist":["generateSummaryFromTranscription.*chunkMeetingInfo"],"shouldExist":["true-2stage-processing"]}]'
```

#### 【強制ルール】自動チェック失敗時の対応
- ❌ **エラー発生時**: 実装・コミットを即座に停止し、要件確認から再開
- ⚠️ **警告発生時**: ユーザーに確認を取ってから継続判断
- 📋 **レポート確認**: `3.operations/verification-reports/`の最新レポートを必ず確認

#### 手動確認項目（自動チェック補完）
1. **ユーザー要求の逐語的引用**: 「」内の文言を正確に引用し理解内容を明文化
2. **実装方針の事前確認**: 曖昧な表現は必ずユーザーに確認、独自解釈禁止
3. **Todo項目との適合性確認**: 各項目が要件通りに実装されているか逐一検証
4. **実装後の要件適合性チェック**: 自動チェックに加えて手動でのコード確認を実施

### 絶対禁止事項（要件理解関連）
- ❌ ユーザーの明示的な指示の独自解釈・変更
- ❌ 曖昧な要件での実装開始（事前確認なし）
- ❌ 形式的なTodo完了（実質的な検証なし）
- ❌ 実装後の要件適合性チェック省略

**違反事例: 2025-09-23「完全文字起こし→要約」要求を「チャンク内2段階」に誤実装**

## 🔴 【最重要】テストの絶対原則 - 1日3回確認必須！

**⚠️ 以下の原則は絶対に違反してはならない。毎回の作業前・作業中・作業後に必ず確認すること。**

### テスト実施の3大原則（2025-08-22制定）

1. **ソースファイルは本番のものをそのまま使うこと**
   - テスト専用コードを新規作成しない
   - 本番環境で動作しているコードをそのまま使用する
   - 別コードでの個別テストは禁止

2. **テスト条件はパラメーターやコード外部で制御する**
   - 音声不良データなどのテスト条件はクエリパラメーターで制御
   - 環境変数やAPIパラメーターを活用
   - コード本体への変更は最小限に抑える

3. **コード変更は最終手段（本番コードのコピー使用）**
   - どうしても必要な場合のみソースファイル丸ごと入れ替え
   - 新規作成ではなく、本番環境のソースをコピーして修正
   - 修正箇所は最小限に留める

### 違反例（絶対にやってはいけない）
- ❌ テスト専用の新規ファイル作成
- ❌ 本番と異なるロジックでのテスト実装
- ❌ モックデータ専用のテストコード作成

### 正しい例
- ✅ 本番API + パラメーター制御（例：`?scenario=1`）
- ✅ 本番コード + 環境変数での挙動制御
- ✅ 本番コードのコピー + 最小限の修正

**確認タイミング：作業開始時・昼・作業終了時の1日3回**

## 🚨 【強制実行】作業開始プロトコル - 絶対に忘れるな！

**Claude Codeは以下を作業開始時に必ず実行すること（例外なし）**

### ステップ1: Cipher復元確認（クラッシュ復旧時）
```bash
# VSCodeクラッシュ後の復旧手順：

# 1. Cipherプロセス確認
ps aux | grep cipher

# 2. Cipher再起動（プロセスが停止している場合）
/opt/homebrew/bin/cipher --mode mcp

# 3. 前回セッション記録確認
cat 3.operations/claude_sessions/latest_session.md

# 4. 対話記録の再保存（必要に応じて）
node 3.operations/src/save-conversation.js

# 5. npm scriptでの実行も可能
npm run save-conversation  # package.json設定が必要
```

### ステップ2: 現状確認（必須）
```bash
# 1. 現在のgitステータス確認
git status
git log --oneline -5

# 2. 前回からの変更差分確認
git diff HEAD~1 --name-only
```

### ステップ3: TodoWrite強制リマインダー（必須）
```
毎回最初に以下タスクを作成：
1. "【必須】現状確認プロトコル実行" (in_progress)
2. "git status/log確認完了" (pending) 
3. "前回変更差分確認完了" (pending)
4. "【NEW】要件理解確認・実装前自動チェック実行完了" (pending)
5. "動作確認テスト実行完了" (pending)
6. "【デグレ防止】影響範囲調査完了" (pending)
7. "【デグレ防止】バックアップポイント作成完了" (pending)
8. "【デグレ防止】修正戦略計画完了" (pending)
9. "【NEW】実装後自動チェック実行完了" (pending)

この9つを全て completed にしてからコミット作業開始
```

### ステップ4: コード修正前の影響範囲調査（デグレ防止強制プロトコル）
```
【絶対必須】コード修正前に以下を実行：

1. 影響範囲調査の実施
   grep -r "修正対象のキーワード" 1.src/ --include="*.js" | wc -l
   find . -name "*.js" -exec grep -l "関連データ構造" {} \;

2. 影響度判定と修正戦略決定
   - 狭い（1-2ファイル）: 単一修正戦略
   - 中程度（3-4ファイル）: 段階的修正戦略  
   - 広い（5ファイル+）: Phase分割戦略

3. バックアップポイント作成
   git tag backup-$(date +%Y%m%d-%H%M%S)

4. 修正範囲とテスト計画の明文化
   echo "修正範囲: [ファイルリスト]" > .modification_plan
   echo "テスト戦略: [Phase別テスト]" >> .modification_plan
```

### ステップ5: エラー発生時の強制プロトコル
```
エラー発生 → 必ず以下を確認：
1. 最近の変更と関係があるか？ (git diff確認)
2. 変更していない部分でのエラーか？
3. 論理的因果関係があるか？
4. 環境要因の可能性は？
5. 即座ロールバック可能か？ (git tag確認)
```

### ステップ6: 変更前の動作確認
- 修正対象の現在の動作状況を必ず確認
- テスト実行で正常性を検証
- 問題がある場合は修正前に報告

**このプロトコルを飛ばして作業を開始してはいけない！**

## 🎯 プロジェクト概要

Zoom録画ファイルを自動で文字起こし・要約し、Google Driveに保存してSlackに通知するシステムです。
- **本番環境**: Vercel (Hobbyプラン)
- **主要技術**: Node.js, Google APIs (Drive, Gemini AI), Slack API, Zoom API
- **開始日**: 2025年7月30日

## 📋 重要な作業ルール

### 0.0 Claude codeとの対話について
- Claude code は全てのチャットの冒頭にこのファイルの原則を逐語的に必ず画面出力してから対応する。
- **作業開始時に必ず上記の【強制実行】作業開始プロトコルを実行すること**
- **プロトコル未実行での作業開始は禁止**

### 禁止事項
- AI側で独自のルール作成
- 指示した以外の無関係のフォルダやファイルの削除
- APIキーやIPアドレスなどのセキュリティ情報および可変データをコード内にベタ書きすること（セキュリティ情報はプラットフォームの環境変数を利用。変数などの可変データは外から入力するか別ファイル二保存して呼び出す形にすること）

### デグレ防止の禁止事項（絶対厳守）
- 影響範囲調査なしでのコード修正
- バックアップポイントなしでの大規模修正
- 複数ファイル同時修正（影響範囲調査で戦略決定後は除く）
- 動作中の機能の削除・置換（並行実装→段階移行の原則）
- Phase分割なしでの5ファイル以上修正
- テスト前の本番デプロイ（段階的修正戦略の場合）
- ロールバック手順未確立での修正開始

### 1. テスト環境と実装方針

#### ✅ やるべきこと
- **本番環境でのテスト実施**: Vercelの本番環境を使用してテストを行う
- **既存コードの活用**: 本番環境で稼働している実際のコードを使用してテストする
- **既存ファイルの編集優先**: 新規ファイル作成よりも既存ファイルの編集を優先する

#### ❌ やってはいけないこと
- **新しいテストスクリプトの作成を避ける**: 既存のコードにデバッグ処理を組み込む
- **ローカル環境でのテスト**: 環境依存の問題を避けるため、必ずVercel環境で実行
- **別コードでの個別テスト**: メソッド名やAPIの書き間違いを防ぐため、本番コードを使用

### 2. デバッグとトラブルシューティング

#### デバッグ時の原則
- 本番コードに直接デバッグログを追加する
- 時間測定や詳細ログは本番コード内に実装する
- エラー発生時は詳細な実行時間とステップ情報を記録する

### 3. Vercel環境の制約

#### 認識すべき制限
- **Hobbyプラン制限**: 
  - 設定上は`maxDuration: 300`（5分）
  - 実際の動作は調査中（60秒制限の可能性あり）
- **サーバーレス環境**:
  - ファイルシステムへの書き込み不可
  - メモリバッファ処理を使用
  - 一時ファイル作成を避ける

### 4. API使用上の注意

#### Google Drive API
- 共有ドライブ対応: `supportsAllDrives: true`を必須で設定
- 組織ドメイン: `grtx.jp`

#### Gemini AI API
- モデル: `gemini-2.5-pro`（自動選択）
- 大容量音声ファイル処理時のタイムアウトに注意

## 📝 コミットメッセージ規約

```
feat: 新機能追加
fix: バグ修正  
refactor: リファクタリング
test: テストコード追加・修正
docs: ドキュメント更新
perf: パフォーマンス改善
debug: デバッグコード追加
```

## 🔐 環境変数

以下の環境変数がVercelに設定されています（変更不要）：
- `GOOGLE_DRIVE_RECORDINGS_FOLDER`: 録画保存フォルダID
- `GOOGLE_DRIVE_ORG_DOMAIN`: grtx.jp
- `SLACK_BOT_TOKEN`: Slackボットトークン
- `SLACK_CHANNEL_ID`: 通知先チャンネルID
- `GOOGLE_AI_API_KEY`: Gemini APIキー
- Google Drive認証情報（各種）

## ⚠️ 重要な注意事項

1. **本番環境での作業**: すべてのテストは本番環境（Vercel）で実施すること
2. **既存コードの尊重**: 新規ファイル作成よりも既存ファイルの修正を優先
3. **メモリ処理優先**: ファイルI/Oを避け、メモリバッファで処理
4. **エラーハンドリング**: 詳細なエラー情報とタイミング情報を記録
5. **段階的デバッグ**: 問題を小さく分割して段階的に調査

## 📞 コミュニケーション

- 作業前に現状を確認し、ユーザーの要望を正確に理解する
- 新しいアプローチを試す前に、ユーザーに確認を取る
- エラーや制限事項は明確に説明する

---

**最終更新:** 2025-08-15
**バージョン:** 3.0 - プロジェクト起動用に簡素化
**自動保存:** Claude Code対話記録（Cipher対応）

## 📝 最新の対話記録と問題解決状況

### 2025-09-26 対話記録

#### 実施内容
- TC205テスト成功確認（228.8秒）
- PT001本番スルーテスト実装
- Zoom OAuth/JWT認証問題の診断
- JWT認証フォールバックテスト実装

#### Zoom認証問題の解決状況
- OAuth: 400 Bad Request → App設定問題
- JWT: 401 Invalid access token → Credentials無効
- 次のアクション: Zoom Marketplace設定確認

#### Cipher自動保存
- 保存時刻: 2025-09-26T04:43:40.860Z
- セッションID: 1758861820860

---

最終更新: 2025-09-26T04:43:40.860Z
自動保存: Cipher連携スクリプト
